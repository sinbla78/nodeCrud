<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Cursor - Collaborative Space</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* Canvas */
    #drawCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: crosshair;
    }

    /* Cursors */
    .cursor {
      position: absolute;
      pointer-events: none;
      transition: transform 0.1s ease-out;
      z-index: 1000;
    }

    .cursor-pointer {
      width: 20px;
      height: 20px;
      transform: rotate(-45deg);
    }

    .cursor-label {
      position: absolute;
      left: 20px;
      top: 15px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      color: white;
      font-weight: 500;
    }

    /* Click Effect */
    .click-effect {
      position: absolute;
      pointer-events: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
      animation: clickRipple 0.6s ease-out forwards;
      z-index: 999;
    }

    @keyframes clickRipple {
      0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
    }

    /* Cursor Trail */
    .cursor-trail {
      position: absolute;
      pointer-events: none;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      opacity: 0.6;
      z-index: 998;
      animation: trailFade 0.5s ease-out forwards;
    }

    @keyframes trailFade {
      0% { transform: scale(1); opacity: 0.6; }
      100% { transform: scale(0); opacity: 0; }
    }

    /* Status Bar */
    .status-bar {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 12px 24px;
      border-radius: 12px;
      color: white;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 16px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 1001;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      background: #4ade80;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .room-name {
      padding: 4px 12px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 6px;
      cursor: pointer;
    }

    .room-name:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .copy-link-btn {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
    }

    .copy-link-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .copy-link-btn.copied {
      background: #4ade80;
    }

    /* User List Panel */
    .user-list-panel {
      position: fixed;
      top: 80px;
      right: 20px;
      width: 200px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 1001;
      max-height: 300px;
      overflow: hidden;
    }

    .user-list-header {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    .user-list {
      max-height: 250px;
      overflow-y: auto;
      padding: 8px;
    }

    .user-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border-radius: 6px;
      color: white;
      font-size: 13px;
    }

    .user-item.me {
      background: rgba(59, 130, 246, 0.2);
    }

    .user-color-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Emoji Reactions */
    .emoji-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 8px 16px;
      border-radius: 30px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      gap: 8px;
      z-index: 1001;
    }

    .emoji-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 8px;
      transition: transform 0.2s, background 0.2s;
    }

    .emoji-btn:hover {
      transform: scale(1.3);
      background: rgba(255, 255, 255, 0.1);
    }

    .floating-emoji {
      position: absolute;
      font-size: 32px;
      pointer-events: none;
      animation: floatUp 2s ease-out forwards;
      z-index: 2000;
    }

    @keyframes floatUp {
      0% {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      100% {
        transform: translateY(-100px) scale(1.5);
        opacity: 0;
      }
    }

    /* Pointer/Ping Effect */
    .ping-effect {
      position: absolute;
      pointer-events: none;
      transform: translate(-50%, -50%);
      z-index: 1500;
    }

    .ping-circle {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 3px solid;
      animation: pingPulse 1.5s ease-out infinite;
    }

    .ping-label {
      position: absolute;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      white-space: nowrap;
      color: white;
      font-weight: 500;
    }

    @keyframes pingPulse {
      0% {
        transform: scale(0.5);
        opacity: 1;
      }
      100% {
        transform: scale(2);
        opacity: 0;
      }
    }

    .pointer-btn {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.2s;
    }

    .pointer-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .pointer-btn.active {
      background: #f59e0b;
    }

    /* Shape Tools */
    .shape-tools {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .shape-btn {
      width: 32px;
      height: 32px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 14px;
      transition: background 0.2s;
    }

    .shape-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .shape-btn.active {
      border-color: white;
      background: rgba(255, 255, 255, 0.2);
    }

    /* Background Color */
    .bg-color-section {
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      font-size: 12px;
    }

    .bg-color-btn {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .bg-color-btn:hover {
      transform: scale(1.1);
    }

    .bg-color-btn.active {
      border-color: white;
    }

    /* Sound Toggle */
    .sound-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      font-size: 12px;
    }

    .sound-toggle button {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: white;
      padding: 4px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .sound-toggle button:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .sound-toggle button.muted {
      opacity: 0.5;
    }

    /* Sticky Notes */
    .sticky-note {
      position: absolute;
      width: 150px;
      min-height: 100px;
      background: #fef3c7;
      border-radius: 4px;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.2);
      z-index: 500;
      cursor: move;
    }

    .sticky-note-header {
      background: rgba(0,0,0,0.1);
      padding: 4px 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: #666;
      border-radius: 4px 4px 0 0;
    }

    .sticky-note-delete {
      background: none;
      border: none;
      cursor: pointer;
      color: #999;
      font-size: 14px;
    }

    .sticky-note-delete:hover {
      color: #ef4444;
    }

    .sticky-note-content {
      padding: 8px;
      font-size: 12px;
      color: #333;
      outline: none;
      min-height: 60px;
    }

    .sticky-note.yellow { background: #fef3c7; }
    .sticky-note.pink { background: #fce7f3; }
    .sticky-note.green { background: #d1fae5; }
    .sticky-note.blue { background: #dbeafe; }

    .add-note-btn {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    .add-note-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    /* Image Upload */
    .canvas-image {
      position: absolute;
      max-width: 300px;
      max-height: 300px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      cursor: move;
      z-index: 400;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .canvas-image:hover {
      border-color: rgba(255, 255, 255, 0.6);
    }

    .image-delete-btn {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 24px;
      height: 24px;
      background: #ef4444;
      border: none;
      border-radius: 50%;
      color: white;
      cursor: pointer;
      font-size: 14px;
      display: none;
    }

    .image-container:hover .image-delete-btn {
      display: block;
    }

    .image-container {
      position: absolute;
      z-index: 400;
    }

    .upload-btn {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    .upload-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    #imageInput {
      display: none;
    }

    /* Cursor Effects */
    .cursor-particle {
      position: absolute;
      pointer-events: none;
      border-radius: 50%;
      z-index: 997;
    }

    .cursor-particle.sparkle {
      animation: sparkle 0.8s ease-out forwards;
    }

    .cursor-particle.trail {
      animation: particleTrail 0.6s ease-out forwards;
    }

    @keyframes sparkle {
      0% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: scale(0) rotate(180deg);
        opacity: 0;
      }
    }

    @keyframes particleTrail {
      0% {
        transform: scale(1);
        opacity: 0.8;
      }
      100% {
        transform: scale(0);
        opacity: 0;
      }
    }

    .cursor-effect-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      font-size: 12px;
    }

    .cursor-effect-toggle select {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    /* Password Room */
    .password-field {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .password-field input {
      flex: 1;
    }

    .password-field label {
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .lock-icon {
      color: #fbbf24;
    }

    .room-item .lock-icon {
      font-size: 12px;
    }

    .password-error {
      color: #ef4444;
      font-size: 12px;
      margin-top: 4px;
    }

    /* My Info */
    .my-info {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 12px 24px;
      border-radius: 12px;
      color: white;
      font-size: 14px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      z-index: 1001;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .edit-nickname-btn {
      background: rgba(255, 255, 255, 0.15);
      border: none;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .edit-nickname-btn:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .color-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      vertical-align: middle;
    }

    /* Drawing Tools */
    .draw-tools {
      position: fixed;
      top: 80px;
      left: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1001;
    }

    .color-picker {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      max-width: 120px;
    }

    .color-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 2px solid transparent;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .color-btn:hover {
      transform: scale(1.2);
    }

    .color-btn.active {
      border-color: white;
    }

    .brush-size {
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      font-size: 12px;
    }

    .brush-size input {
      width: 80px;
    }

    .clear-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }

    .clear-btn:hover {
      background: #dc2626;
    }

    .fade-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      font-size: 12px;
    }

    .fade-toggle input {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .fade-time {
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      font-size: 12px;
    }

    .fade-time select {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    /* Chat Panel */
    .chat-panel {
      position: fixed;
      right: 20px;
      bottom: 20px;
      width: 320px;
      height: 400px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      display: flex;
      flex-direction: column;
      z-index: 1001;
    }

    .chat-header {
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-toggle {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 18px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chat-message {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
    }

    .chat-message .name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .chat-message .text {
      color: rgba(255, 255, 255, 0.9);
      word-break: break-word;
    }

    .chat-message.mine {
      background: rgba(59, 130, 246, 0.3);
      border-left: 3px solid #3b82f6;
    }

    .chat-input-container {
      padding: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      gap: 8px;
    }

    .chat-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      padding: 10px 12px;
      border-radius: 8px;
      color: white;
      font-size: 14px;
    }

    .chat-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .chat-send {
      background: #3b82f6;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
    }

    .chat-send:hover {
      background: #2563eb;
    }

    .chat-panel.minimized {
      height: auto;
    }

    .chat-panel.minimized .chat-messages,
    .chat-panel.minimized .chat-input-container {
      display: none;
    }

    /* Room Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #1e293b;
      padding: 24px;
      border-radius: 16px;
      width: 400px;
      max-width: 90%;
    }

    .modal h2 {
      color: white;
      margin-bottom: 16px;
    }

    .modal input {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 12px;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      margin-bottom: 12px;
    }

    .modal input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .modal-buttons {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .modal-btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .modal-btn.primary {
      background: #3b82f6;
      color: white;
    }

    .modal-btn.secondary {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .room-list {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 16px;
    }

    .room-item {
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .room-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .room-item .count {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
    }

    /* Nickname Modal */
    .nickname-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }

    .nickname-modal.hidden {
      display: none;
    }

    .nickname-modal .modal {
      text-align: center;
    }

    .nickname-modal h2 {
      margin-bottom: 8px;
    }

    .nickname-modal p {
      color: rgba(255, 255, 255, 0.6);
      font-size: 14px;
      margin-bottom: 16px;
    }

    .nickname-modal input {
      text-align: center;
      font-size: 16px;
    }

    /* Instructions */
    .instructions {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: rgba(255, 255, 255, 0.2);
      font-size: 16px;
      text-align: center;
      pointer-events: none;
      z-index: 0;
    }

    #cursors {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <canvas id="drawCanvas"></canvas>

  <div class="status-bar">
    <div class="status-dot"></div>
    <span>Ï†ëÏÜçÏûê: <strong id="userCount">1</strong>Î™Ö</span>
    <div class="room-name" id="roomName" onclick="openRoomModal()">main</div>
    <button class="copy-link-btn" id="copyLinkBtn" onclick="copyRoomLink()">ÎßÅÌÅ¨ Î≥µÏÇ¨</button>
  </div>

  <div class="draw-tools">
    <div class="shape-tools">
      <button class="shape-btn active" data-shape="free" onclick="setShape('free')" title="ÏûêÏú† Í∑∏Î¶¨Í∏∞">‚úèÔ∏è</button>
      <button class="shape-btn" data-shape="line" onclick="setShape('line')" title="ÏßÅÏÑ†">‚ï±</button>
      <button class="shape-btn" data-shape="rect" onclick="setShape('rect')" title="ÏÇ¨Í∞ÅÌòï">‚ñ¢</button>
      <button class="shape-btn" data-shape="circle" onclick="setShape('circle')" title="Ïõê">‚óã</button>
    </div>
    <div class="color-picker" id="colorPicker"></div>
    <div class="brush-size">
      <span>ÍµµÍ∏∞</span>
      <input type="range" id="brushSize" min="1" max="20" value="3">
    </div>
    <div class="fade-toggle">
      <input type="checkbox" id="fadeToggle" checked>
      <span>ÏûêÎèô ÏßÄÏö∞Í∏∞</span>
    </div>
    <div class="fade-time" id="fadeTimeContainer">
      <span>ÏãúÍ∞Ñ</span>
      <select id="fadeTime">
        <option value="5000">5Ï¥à</option>
        <option value="10000" selected>10Ï¥à</option>
        <option value="20000">20Ï¥à</option>
        <option value="30000">30Ï¥à</option>
        <option value="60000">1Î∂Ñ</option>
      </select>
    </div>
    <button class="clear-btn" onclick="clearCanvas()">Ï∫îÎ≤ÑÏä§ ÏßÄÏö∞Í∏∞</button>
    <button class="pointer-btn" id="pointerBtn" onclick="togglePointerMode()">üìç Ïó¨Í∏∞ Î¥ê</button>
    <div class="bg-color-section">
      <span>Î∞∞Í≤Ω</span>
      <div id="bgColorPicker"></div>
    </div>
    <div class="sound-toggle">
      <span>Ìö®Í≥ºÏùå</span>
      <button id="soundToggle" onclick="toggleSound()">üîä</button>
    </div>
    <button class="add-note-btn" onclick="addStickyNote()">üìù Î©îÎ™® Ï∂îÍ∞Ä</button>
    <button class="upload-btn" onclick="document.getElementById('imageInput').click()">üñºÔ∏è Ïù¥ÎØ∏ÏßÄ</button>
    <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)">
    <div class="cursor-effect-toggle">
      <span>Ïª§ÏÑú</span>
      <select id="cursorEffect" onchange="setCursorEffect(this.value)">
        <option value="none">Í∏∞Î≥∏</option>
        <option value="sparkle">Î∞òÏßùÏûÑ</option>
        <option value="fire">Î∂àÍΩÉ</option>
        <option value="rainbow">Î¨¥ÏßÄÍ∞ú</option>
      </select>
    </div>
  </div>

  <div class="instructions">
    ÎßàÏö∞Ïä§Î•º ÏõÄÏßÅÏó¨ Ïª§ÏÑúÎ•º Í≥µÏú†ÌïòÏÑ∏Ïöî<br>
    ÎìúÎûòÍ∑∏ÌïòÏó¨ Í∑∏Î¶ºÏùÑ Í∑∏Î¶¨ÏÑ∏Ïöî<br>
    ÌÅ¥Î¶≠ÌïòÎ©¥ Ïù¥ÌéôÌä∏Í∞Ä ÌëúÏãúÎê©ÎãàÎã§
  </div>

  <div class="my-info" id="myInfo">Ïó∞Í≤∞ Ï§ë...</div>

  <div class="emoji-bar">
    <button class="emoji-btn" onclick="sendEmoji('üëç')">üëç</button>
    <button class="emoji-btn" onclick="sendEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</button>
    <button class="emoji-btn" onclick="sendEmoji('üòÇ')">üòÇ</button>
    <button class="emoji-btn" onclick="sendEmoji('üéâ')">üéâ</button>
    <button class="emoji-btn" onclick="sendEmoji('üëè')">üëè</button>
    <button class="emoji-btn" onclick="sendEmoji('üî•')">üî•</button>
  </div>

  <div class="user-list-panel" id="userListPanel">
    <div class="user-list-header">Ï†ëÏÜçÏûê Î™©Î°ù</div>
    <div class="user-list" id="userList"></div>
  </div>

  <div class="chat-panel" id="chatPanel">
    <div class="chat-header">
      <span>Ï±ÑÌåÖ</span>
      <button class="chat-toggle" onclick="toggleChat()">‚àí</button>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-container">
      <input type="text" class="chat-input" id="chatInput" placeholder="Î©îÏãúÏßÄ ÏûÖÎ†•..." maxlength="500">
      <button class="chat-send" onclick="sendChat()">Ï†ÑÏÜ°</button>
    </div>
  </div>

  <div class="modal-overlay" id="roomModal">
    <div class="modal">
      <h2>Î£∏ ÏÑ†ÌÉù</h2>
      <div class="room-list" id="roomList"></div>
      <input type="text" id="roomInput" placeholder="ÏÉà Î£∏ Ïù¥Î¶Ñ ÏûÖÎ†•...">
      <div class="password-field">
        <label><input type="checkbox" id="usePassword"> ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ï</label>
      </div>
      <input type="password" id="roomPassword" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•..." style="display: none;">
      <div class="password-error" id="passwordError" style="display: none;"></div>
      <div class="modal-buttons">
        <button class="modal-btn secondary" onclick="closeRoomModal()">Ï∑®ÏÜå</button>
        <button class="modal-btn primary" onclick="joinRoom()">ÏûÖÏû•</button>
      </div>
    </div>
  </div>

  <div id="canvasImages"></div>
  <div id="stickyNotes"></div>
  <div id="cursors"></div>

  <div class="nickname-modal" id="nicknameModal">
    <div class="modal">
      <h2>ÎãâÎÑ§ÏûÑ ÏÑ§Ï†ï</h2>
      <p>Ï±ÑÌåÖÍ≥º Ïª§ÏÑúÏóê ÌëúÏãúÎê† Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p>
      <input type="text" id="nicknameInput" placeholder="ÎãâÎÑ§ÏûÑ ÏûÖÎ†•..." maxlength="20">
      <div class="modal-buttons">
        <button class="modal-btn primary" onclick="setNickname()">ÏûÖÏû•</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const cursorsContainer = document.getElementById('cursors');
    const userCountEl = document.getElementById('userCount');
    const myInfoEl = document.getElementById('myInfo');
    const roomNameEl = document.getElementById('roomName');
    const chatMessagesEl = document.getElementById('chatMessages');
    const chatInputEl = document.getElementById('chatInput');
    const chatPanelEl = document.getElementById('chatPanel');
    const roomModalEl = document.getElementById('roomModal');
    const roomListEl = document.getElementById('roomList');
    const roomInputEl = document.getElementById('roomInput');
    const canvas = document.getElementById('drawCanvas');
    const ctx = canvas.getContext('2d');

    const cursors = new Map();
    const users = new Map();
    let currentRoom = new URLSearchParams(window.location.search).get('room') || 'main';
    let myColor = '#ffffff';
    let myUserInfo = null;
    let myNickname = localStorage.getItem('nickname') || '';
    const nicknameModalEl = document.getElementById('nicknameModal');
    const nicknameInputEl = document.getElementById('nicknameInput');
    const userListEl = document.getElementById('userList');

    // Drawing state
    const DRAW_COLORS = ['#ffffff', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7', '#dda0dd', '#ff69b4'];
    let drawExpireMs = 10000;
    let fadeEnabled = true;
    let drawColor = '#ffffff';
    let brushSize = 3;
    let isDrawing = false;
    let lastPos = null;
    const drawings = new Map();
    let pointerMode = false;
    let currentShape = 'free';
    let shapeStartPos = null;
    let soundEnabled = true;
    let cursorEffect = 'none';
    let particleCounter = 0;

    // Sound effects using Web Audio API
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    function playSound(type) {
      if (!soundEnabled) return;

      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      if (type === 'join') {
        oscillator.frequency.setValueAtTime(523, audioContext.currentTime); // C5
        oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.1); // E5
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialDecayTo(0.01, audioContext.currentTime + 0.2);
      } else if (type === 'leave') {
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4
        oscillator.frequency.setValueAtTime(349, audioContext.currentTime + 0.1); // F4
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialDecayTo(0.01, audioContext.currentTime + 0.2);
      } else if (type === 'click') {
        oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
        gainNode.gain.exponentialDecayTo(0.01, audioContext.currentTime + 0.05);
      } else if (type === 'ping') {
        oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(1200, audioContext.currentTime + 0.1);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialDecayTo(0.01, audioContext.currentTime + 0.2);
      } else if (type === 'chat') {
        oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
        gainNode.gain.exponentialDecayTo(0.01, audioContext.currentTime + 0.1);
      }

      oscillator.type = 'sine';
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.3);
    }

    // Polyfill for exponentialDecayTo
    GainNode.prototype.exponentialDecayTo = function(value, endTime) {
      this.gain.exponentialRampToValueAtTime(Math.max(value, 0.0001), endTime);
    };

    function toggleSound() {
      soundEnabled = !soundEnabled;
      const btn = document.getElementById('soundToggle');
      btn.textContent = soundEnabled ? 'üîä' : 'üîá';
      btn.classList.toggle('muted', !soundEnabled);
    }

    function setCursorEffect(effect) {
      cursorEffect = effect;
    }

    function createCursorParticle(x, y, color) {
      if (cursorEffect === 'none') return;
      particleCounter++;
      if (particleCounter % 3 !== 0) return; // Throttle particles

      const particle = document.createElement('div');
      particle.className = 'cursor-particle';

      if (cursorEffect === 'sparkle') {
        particle.classList.add('sparkle');
        const size = 4 + Math.random() * 6;
        particle.style.width = size + 'px';
        particle.style.height = size + 'px';
        particle.style.background = color;
        particle.style.left = (x + (Math.random() - 0.5) * 20) + 'px';
        particle.style.top = (y + (Math.random() - 0.5) * 20) + 'px';
        particle.style.boxShadow = `0 0 ${size}px ${color}`;
      } else if (cursorEffect === 'fire') {
        particle.classList.add('trail');
        const size = 6 + Math.random() * 8;
        const fireColors = ['#ff4500', '#ff6b00', '#ff8c00', '#ffa500', '#ffcc00'];
        const fireColor = fireColors[Math.floor(Math.random() * fireColors.length)];
        particle.style.width = size + 'px';
        particle.style.height = size + 'px';
        particle.style.background = fireColor;
        particle.style.left = (x + (Math.random() - 0.5) * 10) + 'px';
        particle.style.top = (y + Math.random() * 10) + 'px';
        particle.style.boxShadow = `0 0 ${size}px ${fireColor}`;
      } else if (cursorEffect === 'rainbow') {
        particle.classList.add('trail');
        const size = 5 + Math.random() * 5;
        const hue = (Date.now() / 10) % 360;
        particle.style.width = size + 'px';
        particle.style.height = size + 'px';
        particle.style.background = `hsl(${hue}, 100%, 50%)`;
        particle.style.left = (x + (Math.random() - 0.5) * 15) + 'px';
        particle.style.top = (y + (Math.random() - 0.5) * 15) + 'px';
      }

      document.body.appendChild(particle);
      setTimeout(() => particle.remove(), 800);
    }

    // Initialize canvas
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Initialize color picker
    const colorPickerEl = document.getElementById('colorPicker');
    DRAW_COLORS.forEach(color => {
      const btn = document.createElement('button');
      btn.className = 'color-btn' + (color === drawColor ? ' active' : '');
      btn.style.background = color;
      btn.onclick = () => {
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        drawColor = color;
      };
      colorPickerEl.appendChild(btn);
    });

    document.getElementById('brushSize').addEventListener('input', (e) => {
      brushSize = parseInt(e.target.value);
    });

    // Background color picker
    const BG_COLORS = [
      { color: 'linear-gradient(135deg, #1a1a2e 0%, #16213e 100%)', name: 'Í∏∞Î≥∏' },
      { color: '#1a1a1a', name: 'Îã§ÌÅ¨' },
      { color: '#ffffff', name: 'ÌôîÏù¥Ìä∏' },
      { color: '#0a192f', name: 'ÎÑ§Ïù¥ÎπÑ' },
      { color: '#1a472a', name: 'Ìè¨Î†àÏä§Ìä∏' },
      { color: '#2d1b4e', name: 'ÌçºÌîå' }
    ];
    const bgColorPickerEl = document.getElementById('bgColorPicker');
    let currentBgIndex = 0;

    BG_COLORS.forEach((bg, index) => {
      const btn = document.createElement('button');
      btn.className = 'bg-color-btn' + (index === 0 ? ' active' : '');
      btn.style.background = bg.color;
      btn.title = bg.name;
      btn.onclick = () => {
        document.querySelectorAll('.bg-color-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.body.style.background = bg.color;
        currentBgIndex = index;
      };
      bgColorPickerEl.appendChild(btn);
    });

    const fadeToggleEl = document.getElementById('fadeToggle');
    const fadeTimeEl = document.getElementById('fadeTime');
    const fadeTimeContainerEl = document.getElementById('fadeTimeContainer');

    fadeToggleEl.addEventListener('change', (e) => {
      fadeEnabled = e.target.checked;
      fadeTimeContainerEl.style.opacity = fadeEnabled ? '1' : '0.5';
    });

    fadeTimeEl.addEventListener('change', (e) => {
      drawExpireMs = parseInt(e.target.value);
    });

    // Nickname functions
    function showNicknameModal() {
      nicknameInputEl.value = myNickname;
      nicknameModalEl.classList.remove('hidden');
      nicknameInputEl.focus();
    }

    function setNickname() {
      const nickname = nicknameInputEl.value.trim();
      myNickname = nickname;
      if (nickname) {
        localStorage.setItem('nickname', nickname);
      }
      nicknameModalEl.classList.add('hidden');
      socket.emit('cursor:join', { roomId: currentRoom, nickname: myNickname || undefined });
      roomNameEl.textContent = currentRoom;
    }

    nicknameInputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') setNickname();
    });

    function changeNickname() {
      showNicknameModal();
    }

    // Socket events
    socket.on('connect', () => {
      if (!myNickname) {
        showNicknameModal();
      } else {
        socket.emit('cursor:join', { roomId: currentRoom, nickname: myNickname });
        roomNameEl.textContent = currentRoom;
      }
    });

    socket.on('cursor:users', (usersList) => {
      usersList.forEach(data => {
        createCursor(data);
        users.set(data.user.id, data.user);
      });
      renderUserList();
    });

    socket.on('cursor:joined', (data) => {
      users.set(data.user.id, data.user);
      if (data.user.id === socket.id) {
        myUserInfo = data.user;
        myColor = data.user.color;
        myInfoEl.innerHTML = `
          <span>
            <span class="color-indicator" style="background: ${data.user.color}"></span>
            ${data.user.name}
          </span>
          <button class="edit-nickname-btn" onclick="changeNickname()">Î≥ÄÍ≤Ω</button>
        `;
      } else {
        createCursor(data);
        playSound('join');
      }
      renderUserList();
    });

    socket.on('cursor:moved', updateCursor);
    socket.on('cursor:left', (userId) => {
      removeCursor(userId);
      users.delete(userId);
      renderUserList();
      playSound('leave');
    });
    socket.on('room:count', (count) => userCountEl.textContent = count);

    socket.on('cursor:clicked', (data) => {
      createClickEffect(data.position.x, data.position.y, data.color);
      playSound('click');
    });

    socket.on('chat:message', (data) => {
      addChatMessage(data);
      if (data.user.id !== socket.id) {
        playSound('chat');
      }
    });
    socket.on('chat:history', (messages) => {
      chatMessagesEl.innerHTML = '';
      messages.forEach(addChatMessage);
    });

    socket.on('draw:line', (data) => {
      drawings.set(data.id, {
        type: 'line',
        from: data.from,
        to: data.to,
        color: data.color,
        width: data.width,
        timestamp: data.timestamp
      });
    });

    socket.on('draw:shape', (data) => {
      drawings.set(data.id, {
        type: data.shape,
        from: data.from,
        to: data.to,
        color: data.color,
        width: data.width,
        timestamp: data.timestamp
      });
    });

    socket.on('draw:history', (lines) => {
      drawings.clear();
      lines.forEach(line => {
        drawings.set(line.id, {
          from: line.from,
          to: line.to,
          color: line.color,
          width: line.width,
          timestamp: line.timestamp
        });
      });
    });

    socket.on('draw:cleared', () => {
      drawings.clear();
    });

    socket.on('room:list', (rooms) => {
      roomListEl.innerHTML = '';
      rooms.forEach(room => {
        const item = document.createElement('div');
        item.className = 'room-item';
        item.innerHTML = `
          <span>${room.hasPassword ? '<span class="lock-icon">üîí</span> ' : ''}${room.id}</span>
          <span class="count">${room.userCount}Î™Ö</span>
        `;
        item.onclick = () => {
          roomInputEl.value = room.id;
          if (room.hasPassword) {
            roomPasswordEl.style.display = 'block';
            roomPasswordEl.placeholder = 'ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†• (ÌïÑÏàò)';
          }
        };
        roomListEl.appendChild(item);
      });
    });

    // Cursor functions
    function createCursor(data) {
      if (data.user.id === socket.id || cursors.has(data.user.id)) return;

      const cursor = document.createElement('div');
      cursor.className = 'cursor';
      cursor.innerHTML = `
        <svg class="cursor-pointer" viewBox="0 0 24 24" fill="${data.user.color}">
          <path d="M5.5 3.21V20.8c0 .45.54.67.85.35l4.86-4.86a.5.5 0 0 1 .35-.15h6.87c.48 0 .72-.58.38-.92L5.94 2.86a.5.5 0 0 0-.44.35z"/>
        </svg>
        <div class="cursor-label" style="background: ${data.user.color}">${data.user.name}</div>
      `;
      cursor.style.transform = `translate(${data.position.x}px, ${data.position.y}px)`;
      cursorsContainer.appendChild(cursor);
      cursors.set(data.user.id, { element: cursor, color: data.user.color });
    }

    function updateCursor(data) {
      let cursorData = cursors.get(data.user.id);
      if (!cursorData) {
        createCursor(data);
        cursorData = cursors.get(data.user.id);
      }
      if (cursorData) {
        cursorData.element.style.transform = `translate(${data.position.x}px, ${data.position.y}px)`;
        createCursorTrail(data.position.x, data.position.y, cursorData.color);
      }
    }

    function removeCursor(userId) {
      const cursorData = cursors.get(userId);
      if (cursorData) {
        cursorData.element.remove();
        cursors.delete(userId);
      }
    }

    // Effects
    function createClickEffect(x, y, color) {
      const effect = document.createElement('div');
      effect.className = 'click-effect';
      effect.style.left = x + 'px';
      effect.style.top = y + 'px';
      effect.style.border = `3px solid ${color}`;
      document.body.appendChild(effect);
      setTimeout(() => effect.remove(), 600);
    }

    function createCursorTrail(x, y, color) {
      const trail = document.createElement('div');
      trail.className = 'cursor-trail';
      trail.style.left = (x + 10) + 'px';
      trail.style.top = (y + 10) + 'px';
      trail.style.background = color;
      document.body.appendChild(trail);
      setTimeout(() => trail.remove(), 500);
    }

    // Drawing
    function drawLine(from, to, color, width, opacity = 1) {
      ctx.beginPath();
      ctx.globalAlpha = opacity;
      ctx.strokeStyle = color;
      ctx.lineWidth = width;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.moveTo(from.x, from.y);
      ctx.lineTo(to.x, to.y);
      ctx.stroke();
      ctx.globalAlpha = 1;
    }

    function drawShape(shape, from, to, color, width, opacity = 1) {
      ctx.beginPath();
      ctx.globalAlpha = opacity;
      ctx.strokeStyle = color;
      ctx.lineWidth = width;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';

      if (shape === 'line') {
        ctx.moveTo(from.x, from.y);
        ctx.lineTo(to.x, to.y);
      } else if (shape === 'rect') {
        ctx.rect(from.x, from.y, to.x - from.x, to.y - from.y);
      } else if (shape === 'circle') {
        const radius = Math.sqrt(Math.pow(to.x - from.x, 2) + Math.pow(to.y - from.y, 2));
        ctx.arc(from.x, from.y, radius, 0, Math.PI * 2);
      }

      ctx.stroke();
      ctx.globalAlpha = 1;
    }

    // Ïï†ÎãàÎ©îÏù¥ÏÖò Î£®ÌîÑ - Í∑∏Î¶º ÌéòÏù¥Îìú ÏïÑÏõÉ
    function renderCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const now = Date.now();

      drawings.forEach((drawing, id) => {
        let opacity = 1;
        if (fadeEnabled) {
          const age = now - drawing.timestamp;
          if (age >= drawExpireMs) {
            drawings.delete(id);
            return;
          }
          const fadeStart = drawExpireMs * 0.7;
          if (age > fadeStart) {
            opacity = 1 - ((age - fadeStart) / (drawExpireMs * 0.3));
          }
        }

        if (drawing.type === 'line' || !drawing.type) {
          drawLine(drawing.from, drawing.to, drawing.color, drawing.width, opacity);
        } else {
          drawShape(drawing.type, drawing.from, drawing.to, drawing.color, drawing.width, opacity);
        }
      });

      requestAnimationFrame(renderCanvas);
    }
    renderCanvas();

    canvas.addEventListener('mousedown', (e) => {
      isDrawing = true;
      lastPos = { x: e.clientX, y: e.clientY };
      if (currentShape !== 'free') {
        shapeStartPos = { x: e.clientX, y: e.clientY };
      }
    });

    canvas.addEventListener('mousemove', (e) => {
      if (!isDrawing || !lastPos) return;
      const currentPos = { x: e.clientX, y: e.clientY };

      if (currentShape === 'free') {
        socket.emit('draw:line', {
          from: lastPos,
          to: currentPos,
          color: drawColor,
          width: brushSize
        });
        lastPos = currentPos;
      }
    });

    canvas.addEventListener('mouseup', (e) => {
      if (isDrawing && shapeStartPos && currentShape !== 'free') {
        const endPos = { x: e.clientX, y: e.clientY };
        socket.emit('draw:shape', {
          shape: currentShape,
          from: shapeStartPos,
          to: endPos,
          color: drawColor,
          width: brushSize
        });
      }
      isDrawing = false;
      lastPos = null;
      shapeStartPos = null;
    });

    canvas.addEventListener('mouseleave', () => {
      isDrawing = false;
      lastPos = null;
      shapeStartPos = null;
    });

    function clearCanvas() {
      drawings.clear();
      socket.emit('draw:clear');
    }

    // Mouse tracking
    let lastEmit = 0;
    const THROTTLE_MS = 16;

    document.addEventListener('mousemove', (e) => {
      const now = Date.now();
      if (now - lastEmit >= THROTTLE_MS) {
        socket.emit('cursor:move', { position: { x: e.clientX, y: e.clientY } });
        lastEmit = now;
      }
      createCursorParticle(e.clientX, e.clientY, myColor);
    });

    document.addEventListener('click', (e) => {
      if (e.target.closest('.chat-panel, .draw-tools, .status-bar, .modal-overlay, .my-info, .emoji-bar, .user-list-panel')) return;
      if (pointerMode) {
        sendPing(e.clientX, e.clientY);
        return;
      }
      socket.emit('cursor:click', { position: { x: e.clientX, y: e.clientY } });
      createClickEffect(e.clientX, e.clientY, myColor);
    });

    // Chat
    function addChatMessage(data) {
      const msg = document.createElement('div');
      const isMine = data.user.id === socket.id;
      msg.className = 'chat-message' + (isMine ? ' mine' : '');
      msg.innerHTML = `
        <div class="name" style="color: ${data.user.color}">${data.user.name}${isMine ? ' (ÎÇò)' : ''}</div>
        <div class="text">${escapeHtml(data.message)}</div>
      `;
      chatMessagesEl.appendChild(msg);
      chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
    }

    function sendChat() {
      const message = chatInputEl.value.trim();
      if (!message) return;
      socket.emit('chat:send', { message });
      chatInputEl.value = '';
    }

    chatInputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendChat();
    });

    function toggleChat() {
      chatPanelEl.classList.toggle('minimized');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Room
    const usePasswordEl = document.getElementById('usePassword');
    const roomPasswordEl = document.getElementById('roomPassword');
    const passwordErrorEl = document.getElementById('passwordError');
    let pendingRoomJoin = null;

    usePasswordEl.addEventListener('change', (e) => {
      roomPasswordEl.style.display = e.target.checked ? 'block' : 'none';
    });

    function openRoomModal() {
      socket.emit('room:list');
      roomModalEl.classList.add('active');
      roomInputEl.value = '';
      roomPasswordEl.value = '';
      usePasswordEl.checked = false;
      roomPasswordEl.style.display = 'none';
      passwordErrorEl.style.display = 'none';
    }

    function closeRoomModal() {
      roomModalEl.classList.remove('active');
      pendingRoomJoin = null;
    }

    function joinRoom() {
      const newRoom = roomInputEl.value.trim() || 'main';
      const password = usePasswordEl.checked ? roomPasswordEl.value : (roomPasswordEl.value || undefined);

      passwordErrorEl.style.display = 'none';

      if (newRoom !== currentRoom || pendingRoomJoin) {
        pendingRoomJoin = newRoom;
        socket.emit('cursor:join', {
          roomId: newRoom,
          nickname: myNickname || undefined,
          password: password
        });
      } else {
        closeRoomModal();
      }
    }

    socket.on('room:join:error', (data) => {
      passwordErrorEl.textContent = data.message;
      passwordErrorEl.style.display = 'block';
      pendingRoomJoin = null;
    });

    socket.on('room:join:success', () => {
      if (pendingRoomJoin) {
        currentRoom = pendingRoomJoin;
        cursors.forEach((data, id) => data.element.remove());
        cursors.clear();
        users.clear();
        drawings.clear();
        stickyNotes.forEach(note => note.remove());
        stickyNotes.clear();
        canvasImages.forEach(img => img.remove());
        canvasImages.clear();
        chatMessagesEl.innerHTML = '';
        roomNameEl.textContent = currentRoom;
        window.history.pushState({}, '', `?room=${encodeURIComponent(currentRoom)}`);
        pendingRoomJoin = null;
        closeRoomModal();
      }
    });

    roomInputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') joinRoom();
    });

    roomModalEl.addEventListener('click', (e) => {
      if (e.target === roomModalEl) closeRoomModal();
    });

    // Shape tools
    function setShape(shape) {
      currentShape = shape;
      document.querySelectorAll('.shape-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.shape === shape);
      });
    }

    // Pointer mode
    function togglePointerMode() {
      pointerMode = !pointerMode;
      const btn = document.getElementById('pointerBtn');
      btn.classList.toggle('active', pointerMode);
      canvas.style.cursor = pointerMode ? 'crosshair' : 'crosshair';
    }

    function sendPing(x, y) {
      socket.emit('ping:send', { position: { x, y } });
      showPingEffect(x, y, myColor, myUserInfo?.name || 'ÎÇò');
    }

    function showPingEffect(x, y, color, name) {
      const ping = document.createElement('div');
      ping.className = 'ping-effect';
      ping.innerHTML = `
        <div class="ping-circle" style="border-color: ${color}"></div>
        <div class="ping-label" style="background: ${color}">${name}</div>
      `;
      ping.style.left = x + 'px';
      ping.style.top = y + 'px';
      document.body.appendChild(ping);
      setTimeout(() => ping.remove(), 3000);
    }

    socket.on('ping:received', (data) => {
      showPingEffect(data.position.x, data.position.y, data.color, data.name);
      playSound('ping');
    });

    // Emoji reactions
    function sendEmoji(emoji) {
      socket.emit('emoji:send', { emoji });
      showFloatingEmoji(emoji, window.innerWidth / 2, window.innerHeight - 100);
    }

    function showFloatingEmoji(emoji, x, y) {
      const el = document.createElement('div');
      el.className = 'floating-emoji';
      el.textContent = emoji;
      el.style.left = (x - 16) + 'px';
      el.style.top = y + 'px';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2000);
    }

    socket.on('emoji:received', (data) => {
      showFloatingEmoji(data.emoji, data.position.x, data.position.y);
    });

    // User list
    function renderUserList() {
      userListEl.innerHTML = '';
      users.forEach((user, id) => {
        const item = document.createElement('div');
        item.className = 'user-item' + (id === socket.id ? ' me' : '');
        item.innerHTML = `
          <span class="user-color-dot" style="background: ${user.color}"></span>
          <span>${user.name}${id === socket.id ? ' (ÎÇò)' : ''}</span>
        `;
        userListEl.appendChild(item);
      });
    }

    // Image upload
    const canvasImagesContainer = document.getElementById('canvasImages');
    const canvasImages = new Map();

    function handleImageUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        const dataUrl = e.target.result;
        const id = `img-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        const x = 200 + Math.random() * 300;
        const y = 150 + Math.random() * 200;

        socket.emit('image:add', { id, x, y, dataUrl });
      };
      reader.readAsDataURL(file);
      event.target.value = '';
    }

    function createCanvasImage(data) {
      if (canvasImages.has(data.id)) return;

      const container = document.createElement('div');
      container.className = 'image-container';
      container.style.left = data.x + 'px';
      container.style.top = data.y + 'px';

      const img = document.createElement('img');
      img.className = 'canvas-image';
      img.src = data.dataUrl;

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'image-delete-btn';
      deleteBtn.innerHTML = '&times;';
      deleteBtn.onclick = () => socket.emit('image:delete', { id: data.id });

      container.appendChild(img);
      container.appendChild(deleteBtn);

      // Drag functionality
      let isDragging = false;
      let dragOffset = { x: 0, y: 0 };

      img.addEventListener('mousedown', (e) => {
        isDragging = true;
        dragOffset = {
          x: e.clientX - container.offsetLeft,
          y: e.clientY - container.offsetTop
        };
        container.style.zIndex = 401;
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        container.style.left = (e.clientX - dragOffset.x) + 'px';
        container.style.top = (e.clientY - dragOffset.y) + 'px';
      });

      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          container.style.zIndex = 400;
          socket.emit('image:move', {
            id: data.id,
            x: parseInt(container.style.left),
            y: parseInt(container.style.top)
          });
        }
      });

      canvasImagesContainer.appendChild(container);
      canvasImages.set(data.id, container);
    }

    socket.on('image:added', createCanvasImage);

    socket.on('image:moved', (data) => {
      const container = canvasImages.get(data.id);
      if (container) {
        container.style.left = data.x + 'px';
        container.style.top = data.y + 'px';
      }
    });

    socket.on('image:deleted', (data) => {
      const container = canvasImages.get(data.id);
      if (container) {
        container.remove();
        canvasImages.delete(data.id);
      }
    });

    socket.on('image:list', (images) => {
      images.forEach(createCanvasImage);
    });

    // Sticky notes
    const stickyNotesContainer = document.getElementById('stickyNotes');
    const stickyNotes = new Map();
    const NOTE_COLORS = ['yellow', 'pink', 'green', 'blue'];

    function addStickyNote() {
      const id = `note-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      const color = NOTE_COLORS[Math.floor(Math.random() * NOTE_COLORS.length)];
      const x = 200 + Math.random() * 400;
      const y = 150 + Math.random() * 300;

      socket.emit('note:add', { id, x, y, color, content: '' });
    }

    function createStickyNote(data) {
      if (stickyNotes.has(data.id)) return;

      const note = document.createElement('div');
      note.className = `sticky-note ${data.color}`;
      note.style.left = data.x + 'px';
      note.style.top = data.y + 'px';
      note.innerHTML = `
        <div class="sticky-note-header">
          <span>${data.author || 'ÏùµÎ™Ö'}</span>
          <button class="sticky-note-delete" onclick="deleteStickyNote('${data.id}')">&times;</button>
        </div>
        <div class="sticky-note-content" contenteditable="true" data-id="${data.id}">${data.content || ''}</div>
      `;

      // Drag functionality
      let isDragging = false;
      let dragOffset = { x: 0, y: 0 };

      note.querySelector('.sticky-note-header').addEventListener('mousedown', (e) => {
        isDragging = true;
        dragOffset = {
          x: e.clientX - note.offsetLeft,
          y: e.clientY - note.offsetTop
        };
        note.style.zIndex = 501;
      });

      document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const newX = e.clientX - dragOffset.x;
        const newY = e.clientY - dragOffset.y;
        note.style.left = newX + 'px';
        note.style.top = newY + 'px';
      });

      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          note.style.zIndex = 500;
          socket.emit('note:move', {
            id: data.id,
            x: parseInt(note.style.left),
            y: parseInt(note.style.top)
          });
        }
      });

      // Content editing
      const contentEl = note.querySelector('.sticky-note-content');
      contentEl.addEventListener('blur', () => {
        socket.emit('note:update', {
          id: data.id,
          content: contentEl.textContent
        });
      });

      stickyNotesContainer.appendChild(note);
      stickyNotes.set(data.id, note);
    }

    function deleteStickyNote(id) {
      socket.emit('note:delete', { id });
    }

    socket.on('note:added', (data) => {
      createStickyNote(data);
    });

    socket.on('note:moved', (data) => {
      const note = stickyNotes.get(data.id);
      if (note) {
        note.style.left = data.x + 'px';
        note.style.top = data.y + 'px';
      }
    });

    socket.on('note:updated', (data) => {
      const note = stickyNotes.get(data.id);
      if (note) {
        const contentEl = note.querySelector('.sticky-note-content');
        if (document.activeElement !== contentEl) {
          contentEl.textContent = data.content;
        }
      }
    });

    socket.on('note:deleted', (data) => {
      const note = stickyNotes.get(data.id);
      if (note) {
        note.remove();
        stickyNotes.delete(data.id);
      }
    });

    socket.on('note:list', (notes) => {
      notes.forEach(createStickyNote);
    });

    // Copy room link
    function copyRoomLink() {
      const url = `${window.location.origin}?room=${encodeURIComponent(currentRoom)}`;
      navigator.clipboard.writeText(url).then(() => {
        const btn = document.getElementById('copyLinkBtn');
        btn.textContent = 'Î≥µÏÇ¨Îê®!';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'ÎßÅÌÅ¨ Î≥µÏÇ¨';
          btn.classList.remove('copied');
        }, 2000);
      });
    }
  </script>
</body>
</html>
